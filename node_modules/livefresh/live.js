#!/usr/bin/env node

'use strict';

var livereload = require('livereload');
var	fs = require('fs');
var	prompt = require('prompt');

var	path = require('path');
var chemin = path.dirname('./');

var server;

server = livereload.createServer({exts: ['css']});
server.watch(chemin, chemin + "/**/*", chemin + "/**/**/*");


function addScriptTag (){
	fs.readFile('index.html', 'utf8', function (err,data) {
	
		if (data){
			var scriptReload = '<script src="//localhost:35729/livereload.js"></script>';
			
			if (data.search(scriptReload)<0){
				data = data = data.replace('</body>', scriptReload + '</body>');

				fs.writeFile('index.html', data, function (err) {
					if (err) throw err;
						console.log('I add a tag in your code too : <script src="//localhost:35729/livereload.js"></script>');
				});

			}

		}

	});
	askWebServer();
}

function askWebServer(){
	console.log('Do you want i create a webserver for you ? (y/n)');
	prompt.start();
	prompt.get(['response'], function (err, result) {

		if (result.response ==="y"){

			var connect = require('connect');
			var serveStatic = require('serve-static');
			connect().use(serveStatic(chemin)).listen(8080);
			var childProc = require('child_process');
			childProc.exec('open -a "Google Chrome" http://localhost:8080/index.html');
			
		}

		console.log('\n Press "q" to quit when you finish');
		Quitter();

	});

}




function Quitter(){
	var keypress = require('keypress');
 
	// make `process.stdin` begin emitting "keypress" events 
	keypress(process.stdin);
	 
	// listen for the "keypress" event 
	process.stdin.on('keypress', function (ch, key) {
	  //console.log('got "keypress"', key);
	  // if (key && key.ctrl && key.name == 'c') {
	  //   process.stdin.pause();
	  // }
	  if (key.name == 'q') {
	  	console.log("Bye ....");
	  	process.exit();
	  }
	});
	 
	process.stdin.setRawMode(true);
	process.stdin.resume();


}

addScriptTag();
